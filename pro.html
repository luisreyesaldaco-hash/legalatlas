<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Legal Atlas V42 - The Golden Standard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" rel=\"stylesheet\">

    <style>
        /* ESTILOS ORIGINALES DE TU VERSIÓN 7B (CON AJUSTES PARA LA NUBE) */
        :root { --beige: #fdfbf7; --azul: #0a1929; --dorado: #c5a059; --borde: #e8e4db; }
        body, html { height: 100vh; margin: 0; overflow: hidden; background: var(--beige); font-family: 'Segoe UI', sans-serif; }
        
        /* LOGIN (CAPA DE SEGURIDAD) */
        #login-layer { position: fixed; inset: 0; background: radial-gradient(circle at center, #1a2530 0%, #000 100%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-card { background: rgba(255,255,255,0.05); padding: 50px; border: 1px solid var(--dorado); border-radius: 8px; width: 380px; text-align: center; backdrop-filter: blur(10px); color: white; }
        
        /* APP LAYOUT */
        #app-layer { display: none; width: 100vw; height: 100vh; display: flex; }
        
        #sidebar { width: 350px; background: var(--azul); color: white; display: flex; flex-direction: column; border-right: 1px solid var(--dorado); }
        .brand { padding: 25px; font-family: 'Cinzel', serif; font-size: 1.2rem; border-bottom: 1px solid rgba(197, 160, 89, 0.3); text-align: center; letter-spacing: 2px; }
        
        .nav-scroll { flex: 1; overflow-y: auto; padding: 10px; }
        .chapter-btn { display: block; width: 100%; text-align: left; padding: 12px 15px; color: rgba(255,255,255,0.7); background: none; border: none; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.3s; font-size: 0.9rem; }
        .chapter-btn:hover { background: rgba(197, 160, 89, 0.1); color: var(--dorado); padding-left: 20px; }
        .chapter-btn.active { background: rgba(197, 160, 89, 0.2); color: var(--dorado); border-left: 4px solid var(--dorado); font-weight: bold; }
        
        .main-content { flex: 1; display: flex; }
        .viz-panel { width: 60%; background: white; border-right: 1px solid var(--borde); display: flex; flex-direction: column; position: relative; }
        .doc-panel { width: 40%; background: var(--beige); padding: 50px; overflow-y: auto; font-family: 'Merriweather', serif; color: #333; line-height: 1.8; }
        
        .toolbar { height: 60px; border-bottom: 1px solid var(--borde); display: flex; align-items: center; padding: 0 20px; gap: 10px; background: white; }
        .btn-slide { padding: 5px 15px; border: 1px solid var(--borde); border-radius: 20px; background: transparent; font-size: 0.8rem; cursor: pointer; }
        .btn-slide.active { background: var(--azul); color: white; border-color: var(--azul); }
        
        #mermaid-container { flex: 1; overflow: hidden; background-image: radial-gradient(#e0e0e0 1px, transparent 1px); background-size: 20px 20px; }
        
        .highlight { background-color: #ffeeba; transition: background-color 2s ease-out; }
    </style>
</head>
<body>

<div id="login-layer">
    <div class="login-card">
        <h3>LEGAL ATLAS</h3>
        <p class="small text-white-50">GOLDEN STANDARD V42</p>
        <input type="email" id="user-email" class="form-control bg-transparent text-white border-secondary mb-3 text-center" placeholder="Email Corporativo">
        <button class="btn btn-warning w-100 fw-bold" onclick="iniciarSesion()">CONECTAR</button>
    </div>
</div>

<div id="app-layer">
    <nav id="sidebar">
        <div class="brand">LEGAL ATLAS <span style="font-size:0.6rem; border:1px solid var(--dorado); padding: 2px 5px; border-radius: 4px;">PRO</span></div>
        <div id="menu-list" class="nav-scroll">
            <p class="text-center mt-5 text-muted small">Cargando...</p>
        </div>
    </nav>

    <div class="main-content">
        <div class="viz-panel">
            <div class="toolbar">
                <i class="bi bi-diagram-3-fill"></i>
                <div id="tabs-container" style="display:flex; gap:5px; overflow-x:auto;"></div>
            </div>
            <div id="mermaid-container"></div>
        </div>
        <div class="doc-panel">
            <div id="legal-text">
                <h3 class="text-center mt-5">Seleccione un Capítulo</h3>
            </div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://nuzzmcxirsghykzqbmmn.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_yz1em9S40ZqDlB5Ou80Z5g_TCN4hCff';
    const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });
    let panZoomInstance = null;
    let RAW_DATA = [];

    // --- 1. LOGIN ---
    async function iniciarSesion() {
        const email = document.getElementById('user-email').value.trim().toLowerCase();
        const whitelist = ["jaime.ulises292@gmail.com", "td_rogelio@hotmail.com", "admin"];
        
        if (whitelist.includes(email)) {
            document.getElementById('login-layer').style.display = 'none';
            document.getElementById('app-layer').style.display = 'flex';
            await descargarDatos();
        } else {
            alert("Acceso denegado");
        }
    }

    // --- 2. DESCARGA MASIVA (SIMULANDO JSON LOCAL) ---
    async function descargarDatos() {
        const menu = document.getElementById('menu-list');
        menu.innerHTML = "<p class='text-center mt-4 text-warning'>Sincronizando Bóveda...</p>";

        // Pedimos TODO, igual que cuando leías el JSON local
        const { data, error } = await sbClient
            .from('mapas_universales')
            .select('*')
            .eq('nombre_ley', 'Ley Federal del Trabajo')
            .order('id', { ascending: true });

        if (error) { alert("Error de red"); return; }
        
        // AQUÍ ESTÁ EL SECRETO: CONVERTIMOS LA NUBE EN LOCAL
        RAW_DATA = data.map(item => normalizarDatos(item));
        
        renderMenu();
    }

    // --- 3. EL ADAPTADOR MAGICO (SOLUCIONA EL PROBLEMA "PS" Y "NEWLINE") ---
    function normalizarDatos(item) {
        let slidesLimpio = [];
        
        // A. Manejo de Tipos (String vs Objeto)
        try {
            if (typeof item.slides === 'string') {
                slidesLimpio = JSON.parse(item.slides);
            } else if (Array.isArray(item.slides)) {
                slidesLimpio = item.slides;
            } else if (typeof item.slides === 'object') {
                slidesLimpio = [item.slides];
            }
        } catch (e) { console.error("Error parseando slides", e); }

        // B. Limpieza Profunda de Strings (El problema de \n vs \\n)
        if (slidesLimpio && slidesLimpio.length > 0) {
            slidesLimpio = slidesLimpio.map(slide => {
                let code = slide.mermaid_code || "";
                
                // 1. Convertir \\n (doble escape de la nube) a \n (salto real local)
                code = code.replace(/\\n/g, '\n');
                
                // 2. Asegurar que graph TD tenga punto y coma o salto
                if (!code.includes('graph TD;') && !code.includes('graph TD\n')) {
                    code = code.replace('graph TD', 'graph TD\n');
                }
                
                return { ...slide, mermaid_code: code };
            });
        }

        return {
            ...item,
            slides: slidesLimpio
        };
    }

    // --- 4. RENDERIZADO DEL MENÚ (IDÉNTICO A TU VISOR) ---
    function renderMenu() {
        const menu = document.getElementById('menu-list');
        menu.innerHTML = "";
        
        // Agrupación simple (puedes mejorar el ordenamiento aquí si quieres)
        const groups = {};
        RAW_DATA.forEach((item, index) => {
            const titulo = item.orden_1 || "General";
            if (!groups[titulo]) groups[titulo] = [];
            groups[titulo].push({ ...item, originalIndex: index });
        });

        for (const [titulo, capitulos] of Object.entries(groups)) {
            const header = document.createElement('div');
            header.style.padding = "15px 15px 5px";
            header.style.color = "#c5a059";
            header.style.fontSize = "0.7rem";
            header.style.fontWeight = "bold";
            header.style.textTransform = "uppercase";
            header.innerText = titulo;
            menu.appendChild(header);

            capitulos.forEach(cap => {
                const btn = document.createElement('button');
                btn.className = "chapter-btn";
                let nombre = cap.orden_2 || "Capítulo";
                btn.innerText = nombre.length > 40 ? nombre.substring(0, 37) + "..." : nombre;
                btn.onclick = () => cargarCapitulo(cap.originalIndex, btn);
                menu.appendChild(btn);
            });
        }
    }

    // --- 5. CARGA DE CAPÍTULO ---
    function cargarCapitulo(index, btn) {
        document.querySelectorAll('.chapter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const data = RAW_DATA[index];
        document.getElementById('legal-text').innerHTML = data.contenido_html;
        
        const tabs = document.getElementById('tabs-container');
        tabs.innerHTML = "";

        if (!data.slides || data.slides.length === 0) {
            document.getElementById('mermaid-container').innerHTML = "<div class='d-flex align-items-center justify-content-center h-100 text-muted'>Solo Texto</div>";
            return;
        }

        data.slides.forEach((slide, i) => {
            const b = document.createElement('button');
            b.className = `btn-slide ${i===0?'active':''}`;
            b.innerText = slide.titulo || `Proceso ${i+1}`;
            b.onclick = () => {
                document.querySelectorAll('.btn-slide').forEach(x => x.classList.remove('active'));
                b.classList.add('active');
                dibujarMermaid(slide.mermaid_code);
            };
            tabs.appendChild(b);
        });

        // Cargar el primero
        if (data.slides[0]) dibujarMermaid(data.slides[0].mermaid_code);
    }

    // --- 6. EL MOTOR GRÁFICO "GOLDEN" (COPIADO EXACTO DE TU ARCHIVO 7B) ---
    async function dibujarMermaid(code) {
        const area = document.getElementById('mermaid-container');
        
        // Reset Zoom
        if (panZoomInstance) { panZoomInstance.destroy(); panZoomInstance = null; }
        area.removeAttribute('data-processed'); // Importante para re-render

        // PREPARACIÓN DEL CÓDIGO (Lógica original 7B)
        let cleanCode = code.trim();
        
        // Regex mágica del 7B para arreglar nodos
        // Esta es la clave: el 7B usaba una regex específica que funcionaba bien con tu JSON local.
        const fixNodes = (line) => {
            return line.replace(/([a-zA-Z0-9]+)([\(\[\{])(.*?)([\)\]\}])/g, (match, id, open, content, close) => {
                // Aquí el 7B solo limpiaba paréntesis internos
                let safeContent = content.replace(/[\(\)]/g, ' ').trim();
                if (open === '(') return `${id}(["${safeContent}"])`;
                if (open === '[') return `${id}["${safeContent}"]`;
                if (open === '{') return `${id}{"${safeContent}"}`;
                return match;
            });
        };

        // Procesar línea por línea como hacía el 7B
        let lines = cleanCode.split('\n').map(l => {
            if (l.includes('-->')) return l.split('-->').map(p => fixNodes(p.trim())).join(' --> ');
            return fixNodes(l);
        });
        
        // Reconstruir
        cleanCode = lines.join('\n');
        // Asegurar cabecera
        if (!cleanCode.startsWith('graph')) cleanCode = 'graph TD\n' + cleanCode;

        area.innerHTML = cleanCode;

        try {
            await mermaid.run({ nodes: [area] });

            // --- NAVEGACIÓN PRO (PAN & ZOOM) ---
            const svg = area.querySelector('svg');
            if (svg) {
                svg.style.width = '100%';
                svg.style.height = '100%';
                panZoomInstance = svgPanZoom(svg, {
                    zoomEnabled: true,
                    controlIconsEnabled: true,
                    fit: true,
                    center: true,
                    minZoom: 0.1
                });
            }

            // --- EL FRANCOTIRADOR (Clics) ---
            document.querySelectorAll('.node').forEach(node => {
                node.style.cursor = "pointer";
                node.onclick = () => {
                    const match = node.textContent.match(/\d+/);
                    if(match) {
                        const targetId = 'art_' + match[0];
                        const el = document.getElementById(targetId);
                        if(el) {
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            el.classList.add('highlight');
                            setTimeout(() => el.classList.remove('highlight'), 3000);
                        }
                    }
                };
            });

        } catch (e) {
            console.error("Mermaid Error:", e);
            area.innerHTML = "<div class='p-3 text-danger'>Error renderizando gráfico.</div>";
        }
    }
</script>
</body>
</html>