<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Atlas PRO - Sistema Conectado</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
    /* Estilos del Sidebar */
    #sidebar {
        width: 300px;
        background: #f8f9fa;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
    }
    .search-container { padding: 15px; border-bottom: 1px solid #eee; }
    #map-search {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    #menu-content { overflow-y: auto; flex-grow: 1; padding: 10px; }
    
    /* Estilos de los 칤tems del men칰 */
    .menu-group { margin-bottom: 10px; }
    .menu-label { 
        font-weight: bold; 
        font-size: 0.75rem; 
        color: #7f8c8d; 
        text-transform: uppercase; 
        padding: 5px 0;
        border-bottom: 1px solid #eee;
        margin-bottom: 5px;
    }
    .menu-item {
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: 0.2s;
        color: #2c3e50;
    }
    .menu-item:hover { background: #e9ecef; color: #3498db; }
    .menu-item.active { background: #3498db; color: white; font-weight: bold; }
</style>
</head>
<body>

<div id="loader" class="loading-overlay"><h3>Cargando Atlas PRO...</h3></div>

<div id="auth-container">
    <div class="auth-box">
        <h2 style="color: #2c3e50; margin-bottom: 5px;">Legal Atlas PRO</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">츼rea Protegida</p>
        <input type="email" id="email" placeholder="Correo electr칩nico">
        <input type="password" id="password" placeholder="Contrase침a">
        <button onclick="handleLogin()">Entrar</button>
        <button onclick="handleSignup()" style="background: #95a5a6;">Registrarme</button>
    </div>
</div>

<div id="main-app">
    <div class="header-pro">
        <span id="label-jurisdiccion">Legal Atlas PRO</span>
        <div>
            <span id="user-email" style="margin-right: 15px; font-size: 0.8rem; opacity: 0.8;"></span>
            <button onclick="handleLogout()" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Salir</button>
        </div>
    </div>
    <div class="pro-dashboard">
    <nav id="sidebar">
        <div class="search-container">
            <input type="text" id="map-search" placeholder="游댌 Buscar tema o ley..." onkeyup="filterMenu()">
        </div>
        <div id="menu-content">
            <p style="padding: 20px; font-size: 0.8rem; color: #999;">Cargando cat치logo...</p>
        </div>
    </nav>

    <div id="graph-panel"> ... </div>
    <div id="text-panel"> ... </div>
</div>
</div>

<script>
    const SUPABASE_URL = 'https://nuzzmcxirsghykzqbmmn.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_yz1em9S40ZqDlB5Ou80Z5g_TCN4hCff';
    const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- L칍GICA DE AUTH (Mantener igual) ---
    // ... (handleLogin, handleSignup, handleLogout) ...

    sbClient.auth.onAuthStateChange((event, session) => {
        const authContainer = document.getElementById('auth-container');
        const mainApp = document.getElementById('main-app');

        if (session) {
            authContainer.style.display = 'none';
            mainApp.style.display = 'block';
            document.getElementById('user-email').innerText = session.user.email;
            loadMenu(); // 1. Cargar el men칰 primero
        } else {
            authContainer.style.display = 'flex';
            mainApp.style.display = 'none';
        }
    });

    // --- NUEVA L칍GICA DE MEN칔 ---

    async function loadMenu() {
        const { data, error } = await sbClient
            .from('mapas_legales')
            .select('id, pais, jurisdiccion, materia, tema, titulo_capitulo')
            .order('pais', { ascending: true });

        if (error) {
            console.error("Error cargando men칰:", error);
            return;
        }

        const menuContainer = document.getElementById('menu-content');
        menuContainer.innerHTML = '';

        // Agrupamos por Jurisdicci칩n/Materia para orden visual
        const groups = {};
        data.forEach(item => {
            const groupName = `${item.jurisdiccion} - ${item.materia}`;
            if (!groups[groupName]) groups[groupName] = [];
            groups[groupName].push(item);
        });

        for (const group in groups) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'menu-group';
            groupDiv.innerHTML = `<div class="menu-label">${group}</div>`;
            
            groups[group].forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'menu-item';
                itemDiv.innerText = `${item.tema}: ${item.titulo_capitulo}`;
                itemDiv.onclick = () => {
                    // Resaltar activo
                    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
                    itemDiv.classList.add('active');
                    // Cargar mapa
                    initAtlas(item.id);
                };
                groupDiv.appendChild(itemDiv);
            });
            menuContainer.appendChild(groupDiv);
        }

        // Cargar el primero por defecto si hay datos
        if (data.length > 0) {
            initAtlas(data[0].id);
            document.querySelector('.menu-item').classList.add('active');
        }
    }

    // --- BUSCADOR ---
    function filterMenu() {
        const input = document.getElementById('map-search').value.toLowerCase();
        const items = document.querySelectorAll('.menu-item');
        
        items.forEach(item => {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(input) ? "block" : "none";
        });
    }

    // --- L칍GICA DE DATOS MEJORADA ---

    async function initAtlas(id) {
        document.getElementById('loader').style.display = 'flex';
        try {
            const { data, error } = await sbClient
                .from('mapas_legales')
                .select('*')
                .eq('id', id) // AHORA BUSCAMOS POR ID 칔NICO
                .single();

            if (error) throw error;

            // 1. Inyectar Texto Legal
            document.getElementById('text-panel').innerHTML = data.ley_humana_html;
            document.getElementById('titulo-capitulo').innerText = `${data.tema}: ${data.titulo_capitulo}`;
            document.getElementById('label-jurisdiccion').innerText = `Legal Atlas PRO - ${data.jurisdiccion}`;

            // 2. Preparar Mermaid
            const container = document.getElementById('mermaid-container');
            container.removeAttribute('data-processed'); 
            container.innerHTML = data.grafo_json.diagrama;
            
            // 3. Renderizado
            setTimeout(async () => {
                mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });
                await mermaid.run({ nodes: [container] });
            }, 100);

        } catch (err) {
            console.error('Error:', err);
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }
</script>

</body>
</html>