<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directorio | Legal Atlas</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --stone-light: #f4f4f0;
            --stone-dark: #1a1a1a;
            --accent-gold: #b8973d;
            --border-stone: #e5e5e0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--stone-light);
            color: var(--stone-dark);
        }

        .font-classic { font-family: 'Cinzel', serif; }

        .sidebar {
            background: var(--stone-dark);
            border-radius: 28px;
            padding: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .lawyer-card {
            background: white;
            border-radius: 28px;
            padding: 32px;
            border: 1px solid var(--border-stone);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .lawyer-card:hover {
            transform: translateY(-6px);
            border-color: var(--accent-gold);
            box-shadow: 0 20px 40px rgba(0,0,0,0.05);
        }

        .map-container {
            border-radius: 28px;
            overflow: hidden;
            border: 1px solid var(--border-stone);
            height: 450px;
        }

        .btn-wa {
            background: var(--stone-dark);
            color: white;
            padding: 14px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            text-align: center;
            transition: 0.3s;
        }
        .btn-wa:hover { background: var(--accent-gold); }

        .badge-materia {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-gold);
            background: rgba(184, 151, 61, 0.1);
            padding: 4px 12px;
            border-radius: 8px;
        }

        .community-card {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border-radius: 32px;
            padding: 60px;
            color: white;
            text-align: center;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="w-full h-28 flex justify-between items-center px-6 md:px-24">
        <h1 class="font-classic text-2xl tracking-[0.3em]">LEGAL<span class="text-stone-400">ATLAS</span></h1>
        <a href="index.html" class="text-stone-500 hover:text-stone-900 text-[11px] font-bold uppercase tracking-[0.2em]">
            <i class="fas fa-robot mr-2"></i> Volver al Motor APOLO
        </a>
    </nav>

    <div class="flex flex-col lg:flex-row flex-1 px-6 md:px-24 pb-24 gap-12">

        <aside class="sidebar w-full lg:w-80 text-white lg:sticky lg:top-32 h-fit">
            <div class="space-y-10">
                <div>
                    <h2 class="font-classic text-xl text-[#b8973d] mb-1">Explorar</h2>
                    <p class="text-[9px] uppercase tracking-[0.3em] text-stone-400">Filtros Activos</p>
                </div>

                <div class="space-y-6">
                    <div class="flex flex-col space-y-3">
                        <label class="text-[9px] uppercase font-bold tracking-widest">País</label>
                        <select id="filtro-pais" class="bg-white/10 border border-white/20 rounded-xl p-3 text-xs outline-none text-white">
                            <option value="">SELECCIONE PAÍS...</option>
                            <option value="mexico" class="text-black">MÉXICO</option>
                        </select>
                    </div>

                    <div class="flex flex-col space-y-3">
                        <label class="text-[9px] uppercase font-bold tracking-widest">Estado</label>
                        <select id="filtro-estado" class="bg-white/10 border border-white/20 rounded-xl p-3 text-xs outline-none text-white">
                            <option value="">SELECCIONE ESTADO...</option>
                            <option value="guanajuato" class="text-black">GUANAJUATO</option>
                        </select>
                    </div>

                    <div class="flex flex-col space-y-3">
                        <label class="text-[9px] uppercase font-bold tracking-widest">Ciudad</label>
                        <select id="filtro-ciudad" class="bg-white/10 border border-white/20 rounded-xl p-3 text-xs outline-none text-white">
                            <option value="">TODAS LAS CIUDADES</option>
                            <option value="león" class="text-black">LEÓN</option>
                        </select>
                    </div>
                </div>
            </div>

            <p class="text-[9px] text-stone-400 tracking-widest uppercase italic mt-10">
                Infraestructura Verificada
            </p>
        </aside>

        <main class="flex-1">
            <div class="mb-16">
                <h1 class="text-5xl md:text-7xl font-classic text-stone-900 mb-4 tracking-tight">Especialistas.</h1>
                <p class="text-stone-400 text-lg md:text-xl font-light italic">
                    "Conectando personas que cuidan sus derechos con expertos en el deber."
                </p>
            </div>

            <div id="contenedor-abogados" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-20">
                </div>

            <div class="space-y-6 mb-20">
                <div class="flex items-center justify-between px-2">
                    <h2 class="font-classic text-xl text-stone-800 uppercase tracking-widest">Cobertura Local</h2>
                    <span class="text-[10px] text-stone-400 uppercase tracking-widest italic">Mueve el mapa para filtrar</span>
                </div>
                <div id="map" class="map-container shadow-sm bg-stone-200"></div>
            </div>

            <section class="mb-20">
                <div class="community-card">
                    <span class="text-[#b8973d] text-[10px] font-bold uppercase tracking-[0.4em] mb-6 block">Únete a la Red</span>
                    <h2 class="font-classic text-4xl mb-6">Sé parte de nuestra comunidad</h2>
                    <p class="text-stone-400 max-w-2xl mx-auto mb-10 font-light leading-relaxed">
                        Buscamos profesionales del derecho con rigor ético. Si representas una firma de alto nivel, postula tu registro.
                    </p>
                    <a href="registro.html" class="bg-[#b8973d] text-white px-8 py-4 rounded-full text-[10px] font-bold uppercase tracking-widest hover:bg-white hover:text-black transition-all">
                        Postular mi Firma
                    </a>
                </div>
            </section>
        </main>
    </div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    let materiaFiltro = urlParams.get('materia') || ""; 
    
    const client = supabase.createClient('https://nuzzmcxirsghykzqbmmn.supabase.co', 'sb_publishable_yz1em9S40ZqDlB5Ou80Z5g_TCN4hCff');
    
    let map;
    let todosLosAbogados = [];

    async function init() {
        // 1. Cargar datos de Supabase
        const { data, error } = await client
            .from('abogados')
            .select('*')
            .eq('flag_activo', true);

        if (error) {
            console.error("Error cargando Supabase:", error);
            return;
        }

        todosLosAbogados = data || [];

        // 2. Inicializar Mapa (Vista neutra de México)
        map = L.map('map', { zoomControl: false }).setView([23.6345, -102.5528], 5); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        const goldIcon = L.divIcon({
            html: `<div style="background:#b8973d; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px rgba(0,0,0,0.15);"></div>`,
            iconSize: [12, 12]
        });

        // 3. Dibujar TODOS los Marcadores en el mapa
        todosLosAbogados.forEach(a => {
            const coords = validarCoordenadas(a.coords);
            if (coords) {
                L.marker(coords, { icon: goldIcon }).addTo(map)
                    .bindPopup(`<b class="font-classic">${a.nombre}</b>`);
            }
        });

        // 4. Configurar Eventos de los Selects
        document.getElementById('filtro-pais').addEventListener('change', actualizarTarjetasVisibles);
        document.getElementById('filtro-estado').addEventListener('change', actualizarTarjetasVisibles);
        document.getElementById('filtro-ciudad').addEventListener('change', actualizarTarjetasVisibles);
        
        // Al mover el mapa, también refrescamos (por si el usuario busca manualmente)
        map.on('moveend', actualizarTarjetasVisibles);

        // Ejecución inicial
        actualizarTarjetasVisibles();
    }

    function validarCoordenadas(coordString) {
        if (!coordString || typeof coordString !== 'string' || !coordString.includes(',')) return null;
        const parts = coordString.split(',');
        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);
        return (isNaN(lat) || isNaN(lng)) ? null : [lat, lng];
    }

    function actualizarTarjetasVisibles() {
        if (!map) return;
        
        const paisSel = document.getElementById('filtro-pais').value.toLowerCase();
        const estadoSel = document.getElementById('filtro-estado').value.toLowerCase();
        const ciudadSel = document.getElementById('filtro-ciudad').value.toLowerCase();
        const cont = document.getElementById('contenedor-abogados');
        const bounds = map.getBounds();
        
        cont.innerHTML = '';

        // Filtrar los abogados que coinciden con los SELECTS
        const filtradosPorTexto = todosLosAbogados.filter(a => {
            const coincidePais = !paisSel || a.pais?.toLowerCase() === paisSel;
            const coincideEstado = !estadoSel || a.estado?.toLowerCase() === estadoSel;
            const coincideCiudad = !ciudadSel || a.ciudad?.toLowerCase() === ciudadSel;
            
            let coincideMateria = true;
            if (materiaFiltro && a.materia) {
                coincideMateria = a.materia.toLowerCase().includes(materiaFiltro.toLowerCase());
            }

            return coincidePais && coincideEstado && coincideCiudad && coincideMateria;
        });

        // LÓGICA DE AUTO-ENFOQUE: 
        // Si el usuario acaba de elegir un país o estado, movemos el mapa hacia esos abogados automáticamente
        if (filtradosPorTexto.length > 0 && (paisSel || estadoSel)) {
            const puntos = filtradosPorTexto.map(a => validarCoordenadas(a.coords)).filter(c => c);
            if (puntos.length > 0) {
                const group = L.latLngBounds(puntos);
                // Usamos un flag temporal para no entrar en un bucle infinito de eventos moveend
                map.fitBounds(group, { padding: [50, 50], maxZoom: 12 });
            }
        }

        // Ahora filtramos cuáles de esos están VISIBLES en el área actual del mapa para mostrar sus fichas
        const visiblesEnMapa = filtradosPorTexto.filter(a => {
            const coords = validarCoordenadas(a.coords);
            return coords && bounds.contains(coords);
        });

        // Renderizar las tarjetas de los que están en el área visible
        if (visiblesEnMapa.length === 0) {
            cont.innerHTML = '<div class="col-span-full text-center py-20 text-stone-400 uppercase tracking-widest text-[10px]">Sin especialistas visibles en esta zona del mapa</div>';
            return;
        }

        visiblesEnMapa.forEach(a => {
            cont.innerHTML += `
                <div class="lawyer-card">
                    <div>
                        <div class="flex justify-between items-start mb-6">
                            <span class="badge-materia">${a.materia || 'General'}</span>
                            <i class="fas fa-certificate text-stone-200 text-xl"></i>
                        </div>
                        <h3 class="font-classic text-2xl text-stone-900 mb-2">${a.nombre}</h3>
                        <p class="text-[10px] text-stone-400 uppercase tracking-widest mb-6">Firma Verificada</p>
                        <p class="text-stone-500 text-sm font-light leading-relaxed mb-8">
                            Especialista en materia ${a.materia || 'legal'}. Ubicado en ${a.ciudad || a.estado}.
                        </p>
                    </div>
                    <a href="https://wa.me/${a.whatsapp?.replace(/\s+/g, '')}" target="_blank" class="btn-wa">Consultar Representación</a>
                </div>`;
        });
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>